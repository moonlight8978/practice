##### Setup

* `rails active_storage:install`

* `rails db:migrate`

##### Usage

Storage: (Local/Cloud) AWS for example:

```yaml
# config/storage.yml
amazon:
  service: S3
  access_key_id: <%= Rails.application.credentials.dig(:aws, :access_key_id) %>
  secret_access_key: <%= Rails.application.credentials.dig(:aws, :secret_access_key) %>
  region: us-east-1
  bucket: your_own_bucket
```

Rails save our secret keys in encrypted form in `config/credentials.yml.enc`. It's safe to commit to SVN servers.

The file that should not be tracked by Git is `config/master.key`. It contains the autogenerated key that allows to decrypt our credentials.

Rails provides tasks to work with credentials:

```shell
$ EDITOR=vi rails credentials:edit 	# Edit keys
$ rails credentials:show		   	# List all keys
```

In model:

```ruby
class Post < ApplicationRecord
  has_one_attached :cover
  has_many_attached :images
end
```

In views:

```ruby
= f.file_field :cover, class: 'form-control'
= f.file_field :images, multiple: true, class: 'form-control'
```

Controller: permit the attachment keys' name

```ruby
def post_params
  params.require(:post).permit(
    :title, :content, :cover, images: []
  )
end
```

Process:

* Store attachment data into `active_storage_blobs` table: filename, size, checksum...
* `active_storage_attachments` table works as a join table. Store attachment type, its blob id, and the model id.
* Use `ActiveJob` to set the metadata for blobs: width, height

Access from view:

```ruby
= image_tag @post.cover.variant(resize: '300x300')

- @post.images.each do |file|
  - if file.variable? 		 # if file is image
    = image_tag file.variant(resize: '300x300', monochrome: true)
  - elsif file.previewable?  # if file has preview image (PDF...)
    = image_tag file.preview(resize: "100x100")
  - else
    = link_to file.filename, rails_blob_path(file, disposition: :attachment)
```

Rails will send a request to `ActiveStorage::BlobsController#show` to resize/retrieve the image.
Rails use:
* `signed_blob_id`:  to retrieve the blob record from database.
* `key `: to retrieve the blob file saved on disk.
* `variation_key`: to retrieve the resized version (image only).

Some non-image files can be previewed . Extracting previews requires third-party applications, `ffmpeg` for video and `mutool` for PDFs.

```ruby
= link_to(@post.cover.filename, rails_blob_path(@post.cover, disposition: :attachment))
```

Disposition is `:inline` by default, by changing to `:attachment` will result in downloading the attachment.

To delete the attachment, use `#purge`

```ruby
@post.cover.purge
@post.images.first.purge_later 	# background process
@post.images.purge
```

Use custom validator to validate the attachment:

```ruby
validate :validate_cover, if: ->(post) { post.cover.attached? }

def validate_cover
  unless cover.blob.content_type.start_with?('image')
    errors.add(:cover, :invalid_type, message: 'Invalid cover')
  end

  unless cover.blob.byte_size > 10
    errors.add(:cover, :too_small, message: 'Too small')
  end
end
```

Direct uploads

```ruby
= f.file_field :cover, direct_upload: true, class: 'form-control'
```

JS events and more details: [here](http://edgeguides.rubyonrails.org/active_storage_overview.html#direct-upload-javascript-events)
